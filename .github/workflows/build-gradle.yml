name: Build with Gradle

on:
  push:

jobs:
  build-builder:
    strategy:
      matrix:
        os: [ ubuntu-latest ]
    runs-on: ${{ matrix.os }}
    steps:

      - name: "Checkout sources"
        uses: actions/checkout@v3

      - name: "Setup Java"
        uses: actions/setup-java@v3
        with:
          distribution: temurin
          java-version: 17

      - name: "Setup Android NDK"
        uses: nttld/setup-ndk@v1
        with:
          ndk-version: r20b

      - name: "Setup Boost for Linux"
        if: runner.os == 'Linux'
        run: sudo apt install -y libboost-all-dev

      - name: "Setup Boost for macos"
        if: runner.os == 'macOS'
        run: brew install boost

      - name: "Setup Boost for Windows"
        if: runner.os == 'Windows'
        run: echo TODO

      - name: "Setup Swift"
        uses: swift-actions/setup-swift@v1
        with:
          swift-version: "5.7"

      - name: "Setup Gradle"
        uses: gradle/gradle-build-action@v2
        with:
          gradle-home-cache-cleanup: true

      - name: "Execute Gradle build"
        run: ./gradlew build

      - name: "Upload build reports"
        uses: actions/upload-artifact@v3
        with:
          name: build-reports
          path: build/reports/

      - name: "Add build scan URL as PR comment"
        uses: actions/github-script@v5
        if: github.event_name == 'pull_request' && failure()
        with:
          github-token: ${{secrets.GITHUB_TOKEN}}
          script: |
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: '‚ùå ${{ github.workflow }} failed: ${{ steps.gradle.outputs.build-scan-url }}'
            })
